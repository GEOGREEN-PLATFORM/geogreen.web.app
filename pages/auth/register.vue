<template>
  <AuthPageForm :button-options="buttonOptions" @main-button-click="sendRegister">
    <template #form-content>
      <div class="form-content">
        <h1 class="form-content__head gg-h1">Создать аккаунт</h1>
        <div class="form-content__input-fields">
          <div class="form-content__inline-block">
            <KTInput v-model="userData.firstName" label="Имя" />
            <KTInput v-model="userData.lastName" label="Фамилия" />
          </div>
          <KTInput
            v-model="userData.email"
            label="Почта"
            :rules="[validateEmail]"
            type="email"
            name="email"
            autocomplete="new-email"
          />
          <KTInput
            v-model="userData.password"
            label="Пароль"
            type="password"
            autocomplete="new-password"
            :rules="[validatePassword]"
            hint="Пароль должен содержать от 8 до 20 символов"
          />
          <KTInput
            v-model="userData.repeatedPassword"
            label="Подтвердите пароль"
            autocomplete="new-password"
            type="password"
            :rules="[validatePassword, (val) => val === userData.password || 'Пароли не совпадают']"
            hint="Пароль должен содержать от 8 до 20 символов"
          />
        </div>
      </div>
    </template>
    <template #form-footer>
      <div class="form-footer">
        <div class="form-footer__have-account">
          Уже есть аккаунт? <NuxtLink to="/auth/login" class="action-label">Войти</NuxtLink>
        </div>
        <div class="form-footer__accept-rules-block gg-cap">
          Продолжая, вы соглашаетесь с
          <span class="link-label">условиями использования</span> и&nbsp;<span class="link-label"
            >политикой конфидецинальности</span
          >
        </div>
      </div>
    </template>
  </AuthPageForm>
</template>

<script setup lang="ts">
import { useMainStore } from "~/store/main";
definePageMeta({
  layout: "auth",
});

const store = useMainStore();
const { setAccessToken } = useFetchTokens();
const { validateEmail, validatePassword } = useRules();
const { saveUserEmail } = useCheckUser();
const userData = ref<UserRegisterData>({
  password: "",
  repeatedPassword: "",
  firstName: "",
  lastName: "",
  email: "",
});

const buttonOptions = ref<{ main: ButtonOptions; sub: ButtonOptions }>({
  main: {
    designType: "primary",
    label: "Зарегистрироваться",
    loading: false,
  },
  sub: {
    show: false,
  },
});

async function sendRegister() {
  buttonOptions.value.main.loading = true;
  try {
    const user = await $fetch<User>(`${store.apiAuth}/register/user`, {
      method: "POST",
      body: userData.value,
    });
    if (user) {
      store.user = {
        ...user,
        password: "",
      };
      if (
        await setAccessToken({
          email: user.email,
          password: userData.value.password,
        })
      ) {
        saveUserEmail(user.email);
        goToMainPage();
      }
    } else {
      useState<Alert>("showAlert").value = {
        show: true,
        type: "error",
        text: "Не удалось создать аккаунт",
      };
    }
  } catch (error) {
    useState<Alert>("showAlert").value = {
      show: true,
      type: "error",
      text: "Произошла непредвиденная ошибка",
    };
  } finally {
    buttonOptions.value.main.loading = false;
  }
}
function goToMainPage() {
  buttonOptions.value.main.loading = false;
  navigateTo({ path: "/" });
}
</script>

<style lang="scss" scoped>
$app-desktop: 1294px;
$app-laptop: 960px;
$app-mobile: 600px;
$app-narrow-mobile: 364px;

@use "@/assets/styles/pages/auth.scss";
.form-content {
  &__inline-block {
    display: flex;
    min-width: 100%;
    gap: 24px;
    @media screen and (max-width: $app-mobile) {
      flex-direction: column;
      gap: 8px;
    }
  }
}
.form-footer {
  &__have-account {
    text-align: center;
  }
  &__accept-rules-block {
    text-align: center;
  }
}
</style>
